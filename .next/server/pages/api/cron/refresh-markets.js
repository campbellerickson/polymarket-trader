"use strict";(()=>{var e={};e.id=429,e.ids=[429],e.modules={358:e=>{e.exports=require("kalshi-typescript")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},1309:e=>{e.exports=import("@supabase/supabase-js")},9926:e=>{e.exports=import("zod")},8556:(e,t,r)=>{r.a(e,async(e,a)=>{try{r.r(t),r.d(t,{config:()=>c,default:()=>d,routeModule:()=>u});var s=r(1802),o=r(7153),i=r(6249),n=r(5309),l=e([n]);n=(l.then?(await l)():l)[0];let d=(0,i.l)(n,"default"),c=(0,i.l)(n,"config"),u=new s.PagesAPIRouteModule({definition:{kind:o.x.PAGES_API,page:"/api/cron/refresh-markets",pathname:"/api/cron/refresh-markets",bundlePath:"",filename:""},userland:n});a()}catch(e){a(e)}})},8231:(e,t,r)=>{r.a(e,async(e,a)=>{try{r.d(t,{O:()=>n});var s=r(1309),o=r(8159),i=e([s,o]);[s,o]=i.then?(await i)():i;let n=(0,s.createClient)(o.O.SUPABASE_URL,o.O.SUPABASE_KEY);a()}catch(e){a(e)}})},5526:(e,t,r)=>{r.a(e,async(e,a)=>{try{r.d(t,{A0:()=>d,US:()=>n});var s=r(8231),o=r(913),i=e([s,o]);async function n(){let e=new Date(Date.now()-72e5),{data:t,error:r}=await s.O.from("contracts").select("*").gte("discovered_at",e.toISOString()).eq("resolved",!1).order("discovered_at",{ascending:!1});return r?(console.error("Error fetching cached markets:",r),[]):t&&0!==t.length?t.map(e=>({market_id:e.market_id,question:e.question,end_date:new Date(e.end_date),yes_odds:parseFloat(e.current_odds.toString()),no_odds:1-parseFloat(e.current_odds.toString()),liquidity:parseFloat(e.liquidity?.toString()||"0"),volume_24h:parseFloat(e.volume_24h?.toString()||"0"),resolved:e.resolved||!1,category:e.category||void 0,outcome:e.outcome||void 0,final_odds:e.final_odds?parseFloat(e.final_odds.toString()):void 0,resolved_at:e.resolved_at?new Date(e.resolved_at):void 0})):[]}async function l(e){if(0===e.length)return;console.log(`ðŸ’¾ Caching ${e.length} markets to database...`);let t=e.map(e=>({market_id:e.market_id,question:e.question,end_date:e.end_date.toISOString(),current_odds:e.yes_odds,category:e.category||null,liquidity:e.liquidity||0,volume_24h:e.volume_24h||0,resolved:e.resolved||!1,outcome:e.outcome||null,final_odds:e.final_odds||null,resolved_at:e.resolved_at?.toISOString()||null,discovered_at:new Date().toISOString()}));for(let e=0;e<t.length;e+=100){let r=t.slice(e,e+100),{error:a}=await s.O.from("contracts").upsert(r,{onConflict:"market_id",ignoreDuplicates:!1});a?console.error(`Error caching markets chunk ${e/100+1}:`,a):console.log(`   âœ… Cached chunk ${e/100+1}/${Math.ceil(t.length/100)} (${r.length} markets)`)}console.log(`âœ… Cached ${e.length} markets successfully`)}async function d(e){console.log("\uD83D\uDD04 Refreshing market page...",e?`(cursor: ${e.substring(0,20)}...)`:"(first page)");let t=(0,o.DZ)();try{let r=await t.getMarkets(100,e||void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,"open",void 0,void 0),a=r.data.markets||[],s=r.data.cursor||null,i=a.map(e=>{let t;let r=(0,o.TN)(e);try{t=new Date(e.expiration_time||e.expirationTime||e.end_date),isNaN(t.getTime())&&(t=new Date(Date.now()+6048e5))}catch(e){t=new Date(Date.now()+6048e5)}return{market_id:e.ticker||e.market_id||e.id,question:e.title||e.question||e.subtitle||"N/A",end_date:t,yes_odds:null!==r?r/100:0,no_odds:null!==r?(100-r)/100:0,liquidity:0,volume_24h:parseFloat(e.volume||e.volume_24h||0),resolved:"closed"===e.status||"resolved"===e.status,category:e.category||void 0,outcome:e.result?"yes"===e.result?"YES":"NO":void 0,final_odds:e.result_price?parseFloat(e.result_price)/100:void 0,resolved_at:e.settlement_time?new Date(e.settlement_time):void 0}});return await l(i),console.log(`   âœ… Cached ${i.length} markets. Next cursor: ${s?"yes":"no"}`),{markets:i,nextCursor:s,isComplete:!s||0===a.length}}catch(r){if(r.response?.status===429){let e=r.response.headers["retry-after"],t=e?1e3*parseInt(e):5e3;throw Error(`Rate limited. Wait ${t}ms`)}if(r.message?.startsWith("RATE_LIMITED:")){let e=parseInt(r.message.split(":")[1]);throw Error(`Rate limited. Wait ${e}ms`)}let e=r.response?.data?.error?.message||r.message||"Unknown error",t=r.response?.status||500;throw Error(`Kalshi API error: ${t} - ${e}`)}}[s,o]=i.then?(await i)():i,a()}catch(e){a(e)}})},5309:(e,t,r)=>{r.a(e,async(e,a)=>{try{r.r(t),r.d(t,{default:()=>n});var s=r(5526),o=r(8231),i=e([s,o]);async function n(e,t){if(e.headers.authorization!==`Bearer ${process.env.CRON_SECRET}`)return t.status(401).json({error:"Unauthorized"});try{let{data:e}=await o.O.from("performance_metrics").select("*").limit(1);console.log("\uD83D\uDD04 Starting gradual market refresh...");let r=await (0,s.A0)(void 0);return t.status(200).json({success:!0,marketsCached:r.markets.length,hasNextPage:!!r.nextCursor,nextCursor:r.nextCursor,isComplete:r.isComplete,message:r.isComplete?"All markets refreshed":`Refreshed ${r.markets.length} markets. Next page available.`})}catch(a){if(console.error("âŒ Market refresh cron failed:",a),a.message.includes("rate")||a.message.includes("429"))return t.status(200).json({success:!1,error:"Rate limited",message:"Will retry on next scheduled run",retryAfter:a.message.includes("Wait")?a.message:void 0});let{logCronError:e}=await r.e(610).then(r.bind(r,7610));return await e("refresh-markets",a),t.status(500).json({success:!1,error:a.message})}}[s,o]=i.then?(await i)():i,a()}catch(e){a(e)}})}};var t=require("../../../webpack-api-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[947],()=>r(8556));module.exports=a})();