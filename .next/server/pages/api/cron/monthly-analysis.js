"use strict";(()=>{var t={};t.id=739,t.ids=[739,610],t.modules={145:t=>{t.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},1309:t=>{t.exports=import("@supabase/supabase-js")},9926:t=>{t.exports=import("zod")},6249:(t,e)=>{Object.defineProperty(e,"l",{enumerable:!0,get:function(){return function t(e,r){return r in e?e[r]:"then"in e&&"function"==typeof e.then?e.then(e=>t(e,r)):"function"==typeof e&&"default"===r?e:void 0}}})},1034:(t,e,r)=>{r.a(t,async(t,a)=>{try{r.r(e),r.d(e,{config:()=>c,default:()=>_,routeModule:()=>d});var s=r(1802),n=r(7153),o=r(6249),i=r(1810),l=t([i]);i=(l.then?(await l)():l)[0];let _=(0,o.l)(i,"default"),c=(0,o.l)(i,"config"),d=new s.PagesAPIRouteModule({definition:{kind:n.x.PAGES_API,page:"/api/cron/monthly-analysis",pathname:"/api/cron/monthly-analysis",bundlePath:"",filename:""},userland:i});a()}catch(t){a(t)}})},8159:(t,e,r)=>{r.a(t,async(t,a)=>{try{r.d(e,{O:()=>i});var s=r(9926),n=t([s]);let o=(s=(n.then?(await n)():n)[0]).z.object({KALSHI_API_ID:s.z.string().min(1),KALSHI_PRIVATE_KEY:s.z.string().min(1),VERCEL_AI_GATEWAY_KEY:s.z.string().min(1).optional(),AI_GATEWAY_API_KEY:s.z.string().min(1).optional(),VERCEL_OIDC_TOKEN:s.z.string().min(1).optional(),SUPABASE_URL:s.z.string().url(),SUPABASE_KEY:s.z.string().min(1).optional(),SUPABASE_SERVICE_ROLE_KEY:s.z.string().min(1).optional(),CRON_SECRET:s.z.string().min(1),DAILY_BUDGET:s.z.string().transform(Number).default("100"),MIN_ODDS:s.z.string().transform(Number).default("0.85"),MAX_ODDS:s.z.string().transform(Number).default("0.98"),MAX_DAYS_TO_RESOLUTION:s.z.string().transform(Number).default("2"),MIN_LIQUIDITY:s.z.string().transform(Number).default("2000"),DRY_RUN:s.z.string().transform(t=>"true"===t).default("false"),INITIAL_BANKROLL:s.z.string().transform(Number).default("1000")}),i=function(){try{let t=o.parse(process.env),e=t.SUPABASE_KEY||t.SUPABASE_SERVICE_ROLE_KEY;if(!e)throw Error("Missing SUPABASE_KEY (or SUPABASE_SERVICE_ROLE_KEY)");let r=t.VERCEL_AI_GATEWAY_KEY||t.AI_GATEWAY_API_KEY||t.VERCEL_OIDC_TOKEN;if(!r)throw Error("Missing VERCEL_AI_GATEWAY_KEY (or AI_GATEWAY_API_KEY / VERCEL_OIDC_TOKEN)");return{...t,SUPABASE_KEY:e,VERCEL_AI_GATEWAY_KEY:r}}catch(t){if(t instanceof s.z.ZodError){let e=t.errors.map(t=>t.path.join(".")).join(", ");throw Error(`Missing or invalid environment variables: ${e}`)}throw t}}();a()}catch(t){a(t)}})},3288:(t,e,r)=>{r.a(t,async(t,a)=>{try{r.d(e,{B3:()=>i,ce:()=>c,eH:()=>l,zF:()=>_});var s=r(8231),n=r(3435),o=t([s,n]);async function i(t,e){let r=new Date(t,e-1,1),a=new Date(t,e,0,23,59,59),s=String(e).padStart(2,"0");console.log(`ðŸ“Š Generating monthly analysis for ${t}-${s}...`);let o=(await (0,n.Pq)(r,a)).filter(t=>"open"!==t.status&&null!==t.pnl);if(0===o.length)return{month_year:r,total_trades:0,total_invested:0,total_pnl:0,win_rate:0,avg_roi:0,market_type_analysis:{},series_analysis:{},top_market_types:[],top_series_ids:[],worst_market_types:[],worst_series_ids:[],insights:"No resolved trades for this month."};let i={},l={};for(let t of o){let e=function(t,e){if(e)return e;let r=t.toLowerCase();return r.includes("election")||r.includes("vote")||r.includes("candidate")?"Elections/Politics":r.includes("sport")||r.includes("game")||r.includes("match")||r.includes("nfl")||r.includes("nba")||r.includes("mlb")||r.includes("football")||r.includes("basketball")||r.includes("baseball")?"Sports":r.includes("earnings")||r.includes("stock")||r.includes("market")?"Finance/Earnings":r.includes("data")||r.includes("release")||r.includes("report")?"Data Releases":r.includes("deadline")||r.includes("date")||r.includes("by")?"Time-based":r.includes("approval")||r.includes("approve")||r.includes("regulatory")?"Regulatory/Approval":"Other"}(t.contract?.question||"",t.contract?.category),r=function(t){let e=t.split("-");return e.length>=2?e.slice(0,2).join("-"):e[0]||t}(t.contract?.market_id||"");i[e]||(i[e]={trades:0,total_invested:0,total_pnl:0,wins:0,losses:0,win_rate:0,avg_roi:0}),l[r]||(l[r]={trades:0,total_invested:0,total_pnl:0,wins:0,losses:0,win_rate:0,avg_roi:0});let a=t.position_size||0,s=t.pnl||0;i[e].trades++,i[e].total_invested+=a,i[e].total_pnl+=s,"won"===t.status?i[e].wins++:i[e].losses++,l[r].trades++,l[r].total_invested+=a,l[r].total_pnl+=s,"won"===t.status?l[r].wins++:l[r].losses++}let _=t=>{t.win_rate=t.trades>0?t.wins/t.trades:0,t.avg_roi=t.total_invested>0?t.total_pnl/t.total_invested*100:0};Object.values(i).forEach(_),Object.values(l).forEach(_);let c=o.reduce((t,e)=>t+(e.position_size||0),0),d=o.reduce((t,e)=>t+(e.pnl||0),0),u=o.filter(t=>"won"===t.status).length,p=o.length>0?u/o.length:0,y=Object.entries(i).map(([t,e])=>({type:t,roi:e.avg_roi,stats:e})).filter(t=>t.stats.trades>=3),m=Object.entries(l).map(([t,e])=>({series_id:t,roi:e.avg_roi,stats:e})).filter(t=>t.stats.trades>=2),g=y.sort((t,e)=>e.roi-t.roi).slice(0,5).map(t=>({type:t.type,roi:t.roi})),f=y.sort((t,e)=>t.roi-e.roi).slice(0,3).map(t=>({type:t.type,roi:t.roi})),h=m.sort((t,e)=>e.roi-t.roi).slice(0,5).map(t=>({series_id:t.series_id,roi:t.roi})),w=m.sort((t,e)=>t.roi-e.roi).slice(0,3).map(t=>({series_id:t.series_id,roi:t.roi})),E=function(t,e,r,a){let s=[];r.length>0&&s.push(`Best performing market types: ${r.map(t=>`${t.type} (${t.roi.toFixed(1)}% ROI)`).join(", ")}`),a.length>0&&s.push(`Underperforming market types: ${a.map(t=>`${t.type} (${t.roi.toFixed(1)}% ROI)`).join(", ")}`);let n=t.Sports;n&&n.trades>=5&&s.push(`Sports markets: ${n.trades} trades, ${(100*n.win_rate).toFixed(1)}% win rate, ${n.avg_roi.toFixed(1)}% ROI`);let o=t["Elections/Politics"];return(o&&o.trades>=5&&s.push(`Political markets: ${o.trades} trades, ${(100*o.win_rate).toFixed(1)}% win rate, ${o.avg_roi.toFixed(1)}% ROI`),0===s.length)?"Insufficient data for meaningful insights this month.":s.join(". ")+"."}(i,0,g,f);return{month_year:r,total_trades:o.length,total_invested:c,total_pnl:d,win_rate:p,avg_roi:c>0?d/c*100:0,market_type_analysis:i,series_analysis:l,top_market_types:g,top_series_ids:h,worst_market_types:f,worst_series_ids:w,insights:E}}async function l(t){let e=t.month_year.getFullYear(),r=String(t.month_year.getMonth()+1).padStart(2,"0"),a=`${e}-${r}-01`,{error:n}=await s.O.from("monthly_analysis").upsert({month_year:a,total_trades:t.total_trades,total_invested:t.total_invested,total_pnl:t.total_pnl,win_rate:t.win_rate,avg_roi:t.avg_roi,market_type_analysis:t.market_type_analysis,series_analysis:t.series_analysis,top_market_types:t.top_market_types,top_series_ids:t.top_series_ids,worst_market_types:t.worst_market_types,worst_series_ids:t.worst_series_ids,insights:t.insights,updated_at:new Date().toISOString()},{onConflict:"month_year"});if(n)throw Error(`Failed to save monthly analysis: ${n.message}`);console.log(`âœ… Saved monthly analysis for ${a}`)}async function _(t,e){let r=String(e).padStart(2,"0"),a=`${t}-${r}-01`,{data:n,error:o}=await s.O.from("monthly_analysis").select("*").eq("month_year",a).single();if(o){if("PGRST116"===o.code)return null;throw o}return n?{month_year:new Date(n.month_year),total_trades:n.total_trades,total_invested:parseFloat(n.total_invested?.toString()||"0"),total_pnl:parseFloat(n.total_pnl?.toString()||"0"),win_rate:parseFloat(n.win_rate?.toString()||"0"),avg_roi:parseFloat(n.avg_roi?.toString()||"0"),market_type_analysis:n.market_type_analysis||{},series_analysis:n.series_analysis||{},top_market_types:n.top_market_types||[],top_series_ids:n.top_series_ids||[],worst_market_types:n.worst_market_types||[],worst_series_ids:n.worst_series_ids||[],insights:n.insights||""}:null}async function c(){let{data:t,error:e}=await s.O.from("monthly_analysis").select("*").order("month_year",{ascending:!1});if(e)throw e;return t?t.map(t=>({month_year:new Date(t.month_year),total_trades:t.total_trades,total_invested:parseFloat(t.total_invested?.toString()||"0"),total_pnl:parseFloat(t.total_pnl?.toString()||"0"),win_rate:parseFloat(t.win_rate?.toString()||"0"),avg_roi:parseFloat(t.avg_roi?.toString()||"0"),market_type_analysis:t.market_type_analysis||{},series_analysis:t.series_analysis||{},top_market_types:t.top_market_types||[],top_series_ids:t.top_series_ids||[],worst_market_types:t.worst_market_types||[],worst_series_ids:t.worst_series_ids||[],insights:t.insights||""})):[]}[s,n]=o.then?(await o)():o,a()}catch(t){a(t)}})},8231:(t,e,r)=>{r.a(t,async(t,a)=>{try{r.d(e,{O:()=>i});var s=r(1309),n=r(8159),o=t([s,n]);[s,n]=o.then?(await o)():o;let i=(0,s.createClient)(n.O.SUPABASE_URL,n.O.SUPABASE_KEY);a()}catch(t){a(t)}})},3435:(t,e,r)=>{r.a(t,async(t,a)=>{try{r.d(e,{$r:()=>l,FC:()=>y,Jg:()=>d,Of:()=>g,Pq:()=>_,Xb:()=>c,Xx:()=>m,dY:()=>p,fT:()=>f,lv:()=>i,mo:()=>o,sl:()=>u,zC:()=>h});var s=r(8231),n=t([s]);async function o(){let{data:t,error:e}=await s.O.from("trades").select(`
      *,
      contract:contracts(*)
    `).eq("status","open").order("executed_at",{ascending:!1});if(e)throw e;return t}async function i(t=50){let{data:e,error:r}=await s.O.from("trades").select(`
      *,
      contract:contracts(*)
    `).order("executed_at",{ascending:!1}).limit(t);if(r)throw r;return e}async function l(){let t=new Date;t.setHours(0,0,0,0);let{data:e,error:r}=await s.O.from("trades").select(`
      *,
      contract:contracts(*)
    `).gte("executed_at",t.toISOString()).order("executed_at",{ascending:!1});if(r)throw r;return e}async function _(t,e){let{data:r,error:a}=await s.O.from("trades").select(`
      *,
      contract:contracts(*)
    `).gte("executed_at",t.toISOString()).lte("executed_at",e.toISOString()).order("executed_at",{ascending:!1});if(a)throw a;return r}async function c(t){let{data:e,error:r}=await s.O.from("trades").insert({...t,status:"open",executed_at:new Date().toISOString()}).select(`
      *,
      contract:contracts(*)
    `).single();if(r)throw r;return e}async function d(t,e){let{data:r,error:a}=await s.O.from("trades").update(e).eq("id",t).select(`
      *,
      contract:contracts(*)
    `).single();if(a)throw a;return r}async function u(){return(await o()).map(t=>({trade:t,current_odds:t.entry_odds,unrealized_pnl:0,unrealized_pnl_pct:0}))}async function p(){let{data:t}=await s.O.from("performance_metrics").select("bankroll").order("date",{ascending:!1}).limit(1).single();return t?.bankroll||Number(process.env.INITIAL_BANKROLL)||1e3}async function y(){return Number(process.env.INITIAL_BANKROLL)||1e3}async function m(t){let{data:e}=await s.O.from("performance_metrics").select("bankroll").lte("date",t.toISOString()).order("date",{ascending:!1}).limit(1).single();return e?.bankroll||Number(process.env.INITIAL_BANKROLL)||1e3}async function g(){let t=await p(),e=(await u()).reduce((t,e)=>t+e.trade.position_size,0);return t-e}async function f(){let{data:t,error:e}=await s.O.from("notification_preferences").select("*").eq("user_id","default").single();if(e&&"PGRST116"!==e.code)throw e;return t||{enabled:!1}}async function h(t){let e=new Date(Date.now()-36e5*t),{data:r,error:a}=await s.O.from("stop_loss_events").select(`
      *,
      trade:trades(
        *,
        contract:contracts(*)
      )
    `).gte("executed_at",e.toISOString()).order("executed_at",{ascending:!1});if(a)throw a;return r}s=(n.then?(await n)():n)[0],a()}catch(t){a(t)}})},7610:(t,e,r)=>{r.a(t,async(t,a)=>{try{r.d(e,{logCronError:()=>i,logError:()=>o});var s=r(8231),n=t([s]);async function o(t,e,r,a,n="system"){try{await s.O.from("error_logs").insert({level:t,message:e,error:r?.message,stack:r?.stack,context:a?JSON.stringify(a):null,source:n,timestamp:new Date().toISOString()}),("error"===t?console.error:"warning"===t?console.warn:console.log)(`[${t.toUpperCase()}] ${e}`,r,a)}catch(s){console.error("Failed to log to database:",s),console.error(`[${t.toUpperCase()}] ${e}`,r,a)}}async function i(t,e,r){await o("error",`Cron job ${t} failed: ${e.message}`,e,r,"cron")}s=(n.then?(await n)():n)[0],a()}catch(t){a(t)}})},1810:(t,e,r)=>{r.a(t,async(t,a)=>{try{r.r(e),r.d(e,{default:()=>i});var s=r(3288),n=r(7610),o=t([s,n]);async function i(t,e){if(t.headers.authorization!==`Bearer ${process.env.CRON_SECRET}`)return e.status(401).json({error:"Unauthorized"});try{let r=new Date,a=r.getMonth()+1,n=r.getFullYear(),o=n,i=a-1;0===i&&(i=12,o=n-1),t.query.year&&t.query.month&&(o=parseInt(t.query.year),i=parseInt(t.query.month)),console.log(`ðŸ“Š Generating monthly analysis for ${o}-${String(i).padStart(2,"0")}...`);let l=await (0,s.B3)(o,i);return await (0,s.eH)(l),console.log(`âœ… Monthly analysis complete:`),console.log(`   Total trades: ${l.total_trades}`),console.log(`   Total P&L: $${l.total_pnl.toFixed(2)}`),console.log(`   Win rate: ${(100*l.win_rate).toFixed(1)}%`),console.log(`   Avg ROI: ${l.avg_roi.toFixed(2)}%`),console.log(`   Market types analyzed: ${Object.keys(l.market_type_analysis).length}`),console.log(`   Series IDs analyzed: ${Object.keys(l.series_analysis).length}`),e.status(200).json({success:!0,month:`${o}-${String(i).padStart(2,"0")}`,analysis:{total_trades:l.total_trades,total_pnl:l.total_pnl,win_rate:l.win_rate,avg_roi:l.avg_roi,market_types_count:Object.keys(l.market_type_analysis).length,series_count:Object.keys(l.series_analysis).length,top_market_types:l.top_market_types,top_series_ids:l.top_series_ids,insights:l.insights}})}catch(t){return console.error("âŒ Monthly analysis cron failed:",t),await (0,n.logCronError)("monthly-analysis",t),e.status(500).json({success:!1,error:t.message})}}[s,n]=o.then?(await o)():o,a()}catch(t){a(t)}})},7153:(t,e)=>{var r;Object.defineProperty(e,"x",{enumerable:!0,get:function(){return r}}),function(t){t.PAGES="PAGES",t.PAGES_API="PAGES_API",t.APP_PAGE="APP_PAGE",t.APP_ROUTE="APP_ROUTE"}(r||(r={}))},1802:(t,e,r)=>{t.exports=r(145)}};var e=require("../../../webpack-api-runtime.js");e.C(t);var r=e(e.s=1034);module.exports=r})();